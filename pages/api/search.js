import fs from "fs";
import path from "path";
const DATA_PATH = path.join(process.cwd(), "data", "messages.json");
export default function handler(req, res) { try { const q = (req.query.q || "").trim().toLowerCase(); const limit = Math.min(200, parseInt(req.query.limit || "20", 10)); if (!q) return res.status(400).json({ error: "Missing q parameter" }); const manifest = JSON.parse(fs.readFileSync(DATA_PATH, "utf8")); const results = []; for (const m of manifest) { try { const mdPath = m.path && !path.isAbsolute(m.path) ? path.join(process.cwd(), m.path) : m.path; let body = ""; if (mdPath && fs.existsSync(mdPath)) { body = fs.readFileSync(mdPath, "utf8"); } else { body = `${m.title}\n${m.excerpt}`; } const hay = body.toLowerCase(); if (hay.indexOf(q) !== -1) { const idx = hay.indexOf(q); results.push({ ...m, score: Math.max(0, 100000 - idx) }); } } catch (e) { continue; } } results.sort((a, b) => { if (b.score !== a.score) return b.score - a.score; return (b.date || "").localeCompare(a.date || ""); }); res.setHeader("Cache-Control", "s-maxage=30, stale-while-revalidate=60"); res.status(200).json({ total: results.length, results: results.slice(0, limit) }); } catch (err) { console.error("API /api/search error:", err); res.status(500).json({ error: "Search failed" }); } }
