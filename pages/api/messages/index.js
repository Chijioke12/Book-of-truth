import fs from "fs";
import path from "path";
const DATA_PATH = path.join(process.cwd(), "data", "messages.json");
export default function handler(req, res) { try { const raw = fs.readFileSync(DATA_PATH, "utf8"); const all = JSON.parse(raw); const q = (req.query.q || "").trim().toLowerCase(); const page = Math.max(1, parseInt(req.query.page || "1", 10)); const limit = Math.min(200, Math.max(1, parseInt(req.query.limit || "20", 10))); const sort = req.query.sort === "title" ? "title" : "date"; let results = all; if (q) { results = results.filter((m) => { const hay = `${m.title} ${m.excerpt}`.toLowerCase(); return hay.includes(q); }); } if (sort === "date") { results.sort((a, b) => { const da = a.date || ""; const db = b.date || ""; if (da === db) return 0; return da < db ? 1 : -1; }); } else { results.sort((a, b) => a.title.localeCompare(b.title)); } const total = results.length; const start = (page - 1) * limit; const paged = results.slice(start, start + limit); res.setHeader("Cache-Control", "s-maxage=300, stale-while-revalidate=600"); res.status(200).json({ total, page, limit, results: paged, }); } catch (err) { console.error("API /api/messages error:", err); res.status(500).json({ error: "Failed to read manifest" }); } }
