import fs from "fs";
import path from "path";
const DATA_PATH = path.join(process.cwd(), "data", "messages.json");
const CONTENT_DIR = path.join(process.cwd(), "content", "messages");
export default function handler(req, res) { try { const { slug } = req.query; if (!slug) return res.status(400).json({ error: "Missing slug" }); const manifest = JSON.parse(fs.readFileSync(DATA_PATH, "utf8")); const entry = manifest.find((m) => m.slug === slug || m.id === slug); if (!entry) return res.status(404).json({ error: "Message not found" }); const mdPath = entry.path ? (path.isAbsolute(entry.path) ? entry.path : path.join(process.cwd(), entry.path)) : path.join(CONTENT_DIR, `${entry.date ? entry.date + "-" : ""}${entry.slug}.md`); if (!fs.existsSync(mdPath)) return res.status(404).json({ error: "Message file missing" }); const raw = fs.readFileSync(mdPath, "utf8"); let front = {}; let body = raw; if (raw.startsWith("---")) { const parts = raw.split("---"); if (parts.length >= 3) { try { const yaml = parts[1].trim(); yaml.split(/\r?\n/).forEach((ln) => { const m = ln.match(/^([^:]+):\s*(.*)$/); if (m) { const key = m[1].trim(); let val = m[2].trim(); if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) { val = val.slice(1, -1); } front[key] = val; } }); } catch (e) {} body = parts.slice(2).join("---").trim(); } } res.setHeader("Cache-Control", "s-maxage=3600, stale-while-revalidate=7200"); res.status(200).json({ id: entry.id, title: front.title || entry.title, date: front.date || entry.date, slug: entry.slug, excerpt: front.excerpt || entry.excerpt, body, }); } catch (err) { console.error("API /api/messages/[slug] error:", err); res.status(500).json({ error: "Failed to load message" }); } }
